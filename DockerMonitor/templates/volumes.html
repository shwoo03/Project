{% extends "base.html" %}

{% block title %}WSunghun / Docker - Volumes{% endblock %}

{% block head %}
<style>
    .volume-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        position: relative;
    }

    .volume-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
    }

    .volume-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .volume-name {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-main);
        word-break: break-all;
    }

    .volume-name i {
        color: #ec4899;
        /* Pink for volumes */
    }

    .volume-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        background: rgba(236, 72, 153, 0.1);
        color: #f472b6;
        border: 1px solid rgba(236, 72, 153, 0.3);
        white-space: nowrap;
    }

    .volume-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .meta-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: 'JetBrains Mono', monospace;
    }

    .meta-value {
        font-size: 0.85rem;
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-main);
        word-break: break-all;
    }

    .volume-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        border-top: 1px solid var(--border);
        padding-top: 15px;
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 25px;
        width: 90%;
        max-width: 500px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
    }

    .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-close:hover {
        color: var(--text-main);
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .form-input {
        width: 100%;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-main);
        font-family: inherit;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .btn-modal {
        width: 100%;
        padding: 10px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
    }

    .btn-modal.secondary {
        background: var(--border);
        margin-top: 10px;
    }

    pre.json-view {
        background: #000;
        padding: 10px;
        border-radius: 6px;
        overflow: auto;
        max-height: 400px;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Create Volume Modal -->
<div class="modal-overlay" id="create-modal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Create New Volume</span>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="form-group">
            <label class="form-label">Volume Name</label>
            <input type="text" class="form-input" id="new-volume-name" placeholder="my-volume">
        </div>
        <div class="form-group">
            <label class="form-label">Driver (Optional)</label>
            <input type="text" class="form-input" id="new-volume-driver" placeholder="local" value="local">
        </div>
        <button class="btn-modal" onclick="createVolume()">Create</button>
    </div>
</div>

<!-- Inspect Modal -->
<div class="modal-overlay" id="inspect-modal">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <span class="modal-title">Volume Details</span>
            <button class="modal-close" onclick="closeInspectModal()">&times;</button>
        </div>
        <div id="inspect-content"></div>
    </div>
</div>

<h1 class="dashboard-title">Volumes.</h1>
<p class="dashboard-desc">Manage persistent data storage volumes.</p>

<div class="stats-row">
    <div class="stat-item">
        <span class="stat-label">Total Volumes</span>
        <span class="stat-value" id="total-count">0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Local Driver</span>
        <span class="stat-value" id="local-count" style="color: #f472b6">0</span>
    </div>
</div>

<div class="section-header">
    <h2>Volume List</h2>
    <div style="display: flex; gap: 10px;">
        <button class="btn-mini" onclick="openCreateModal()"
            style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3);">
            <i class="fas fa-plus"></i> Create
        </button>
        <button class="btn-mini" onclick="loadVolumes()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<div class="volume-list" id="volume-list">
    <div class="loading-spinner">
        <i class="fas fa-circle-notch"></i>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const volumeList = document.getElementById('volume-list');
    const totalEl = document.getElementById('total-count');
    const localEl = document.getElementById('local-count');

    async function loadVolumes() {
        volumeList.innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-circle-notch"></i>
                </div>
            `;

        try {
            const response = await fetch('/api/volumes');
            const result = await response.json();
            const volumes = result.data;

            // Update counts
            totalEl.textContent = volumes.length;
            localEl.textContent = volumes.filter(v => v.driver === 'local').length;

            renderVolumes(volumes);
        } catch (error) {
            console.error('Error loading volumes:', error);
            volumeList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Failed to load volumes</h3>
                        <p>${error.message}</p>
                    </div>
                `;
        }
    }

    function renderVolumes(volumes) {
        if (volumes.length === 0) {
            volumeList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-hdd"></i>
                        <h3>No Volumes Found</h3>
                        <p>Create a volume to see it here.</p>
                    </div>
                `;
            return;
        }

        volumeList.innerHTML = volumes.map(vol => `
                <div class="volume-card">
                    <div class="volume-header">
                        <div class="volume-name">
                            <i class="fas fa-hdd"></i>
                            ${vol.name}
                        </div>
                        <span class="volume-badge">${vol.driver}</span>
                    </div>
                    
                    <div class="volume-meta">
                        <div class="meta-item">
                            <span class="meta-label">Mountpoint</span>
                            <span class="meta-value">${vol.mountpoint}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Created</span>
                            <span class="meta-value">${vol.created}</span>
                        </div>
                    </div>

                    <div class="volume-actions">
                        <button class="btn-mini" onclick="inspectVolume('${vol.name}')">
                            <i class="fas fa-info-circle"></i> Inspect
                        </button>
                        <button class="btn-mini stop-btn" onclick="deleteVolume('${vol.name}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
    }

    // --- Actions ---

    async function createVolume() {
        const name = document.getElementById('new-volume-name').value;
        const driver = document.getElementById('new-volume-driver').value;

        if (!name) {
            if (typeof showToast === 'function') showToast('Volume name is required', 'error');
            return;
        }

        try {
            const res = await fetch('/api/volumes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, driver })
            });
            const result = await res.json();

            if (result.success) {
                if (typeof showToast === 'function') showToast('Volume created successfully', 'success');
                closeCreateModal();
                loadVolumes();
            } else {
                if (typeof showToast === 'function') showToast(`Failed: ${result.message}`, 'error');
            }
        } catch (e) {
            if (typeof showToast === 'function') showToast(`Error: ${e.message}`, 'error');
        }
    }

    async function deleteVolume(name) {
        if (!confirm(`Are you sure you want to delete volume "${name}"?`)) return;

        try {
            const res = await fetch(`/api/volumes/${name}`, { method: 'DELETE' });
            const result = await res.json();

            if (result.success) {
                if (typeof showToast === 'function') showToast('Volume deleted successfully', 'success');
                loadVolumes(); // Refresh list
            } else {
                if (typeof showToast === 'function') showToast(`Failed: ${result.message}`, 'error');
            }
        } catch (e) {
            if (typeof showToast === 'function') showToast(`Error: ${e.message}`, 'error');
        }
    }

    async function inspectVolume(name) {
        try {
            const res = await fetch(`/api/volumes/${name}`);
            const data = await res.json();

            const content = document.getElementById('inspect-content');
            content.innerHTML = `<pre class="json-view">${JSON.stringify(data, null, 2)}</pre>`;

            document.getElementById('inspect-modal').style.display = 'flex';
        } catch (e) {
            if (typeof showToast === 'function') showToast(`Error: ${e.message}`, 'error');
        }
    }

    // --- Modals ---
    function openCreateModal() {
        document.getElementById('new-volume-name').value = '';
        document.getElementById('create-modal').style.display = 'flex';
    }

    function closeCreateModal() {
        document.getElementById('create-modal').style.display = 'none';
    }

    function closeInspectModal() {
        document.getElementById('inspect-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = 'none';
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', loadVolumes);
</script>
{% endblock %}