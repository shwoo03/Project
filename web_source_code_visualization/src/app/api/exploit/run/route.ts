import { NextResponse } from 'next/server';
import { exec } from 'child_process';
import util from 'util';
import fs from 'fs';
import path from 'path';
import os from 'os';

const execAsync = util.promisify(exec);

export async function POST(req: Request) {
    try {
        const { code } = await req.json();

        if (!code) {
            return NextResponse.json({ error: 'No exploit code provided' }, { status: 400 });
        }

        // Create temp file for exploit
        const tmpDir = os.tmpdir();
        const tmpFilePath = path.join(tmpDir, `exploit_${Date.now()}.py`);

        fs.writeFileSync(tmpFilePath, code);

        // Run python script
        // Timeout 10s to prevent hang
        try {
            const { stdout, stderr } = await execAsync(`python "${tmpFilePath}"`, { timeout: 10000 });

            // Clean up
            fs.unlinkSync(tmpFilePath);

            return NextResponse.json({
                output: stdout,
                error: stderr,
                success: true
            });
        } catch (e: any) {
            if (fs.existsSync(tmpFilePath)) fs.unlinkSync(tmpFilePath);

            return NextResponse.json({
                output: e.stdout,
                error: e.stderr || e.message,
                success: false
            });
        }

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
