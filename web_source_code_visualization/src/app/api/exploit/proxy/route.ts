import { NextResponse } from 'next/server';
import axios from 'axios';

// Wrapper removed (manual cookie handling used instead)
const client = axios.create();

export async function POST(req: Request) {
    try {
        const { targetUrl, method, params, data, cookies } = await req.json();

        // Convert cookies dictionary to "Cookie: key=val" string if needed, 
        // or just let axios handle it if we pass options.
        // Axios 'Cookie' header handling with cookiejar is automatic if using jar,
        // but for specific request injection we might need manual headers.

        const headers: Record<string, string> = {};
        if (cookies && Object.keys(cookies).length > 0) {
            headers['Cookie'] = Object.entries(cookies).map(([k, v]) => `${k}=${v}`).join('; ');
        }

        const config = {
            method: method || 'GET',
            url: targetUrl,
            params: params, // For GET query params
            data: data,     // For POST body
            headers: headers,
            validateStatus: () => true // Don't throw on 401/404/etc
        };

        console.log(`[Proxy] Forwarding ${method} to ${targetUrl}`, { params, data, cookies });

        const response = await axios(config);

        return NextResponse.json({
            status: response.status,
            statusText: response.statusText,
            headers: response.headers,
            data: typeof response.data === 'object' ? JSON.stringify(response.data) : response.data
        });

    } catch (error: any) {
        console.error('[Proxy Error]', error.message);
        return NextResponse.json({
            error: `Connection Failed: ${error.message}. Is the target server (port 8000) running?`
        }, { status: 502 });
    }
}
