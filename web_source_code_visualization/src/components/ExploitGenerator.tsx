import React, { useState } from 'react';
import { RouteData } from '@/lib/graph-transformer';
import { Copy, Terminal, FlaskConical, Zap, Play } from 'lucide-react';
import { simulateExploit } from '@/lib/simulator';

interface Props {
    data: RouteData;
    onRun?: (result: any) => void;
}

export default function ExploitGenerator({ data, onRun }: Props) {
    const [copied, setCopied] = useState(false);
    // State to hold user values for parameters
    const [paramValues, setParamValues] = useState<Record<string, string>>({});
    const [simOutput, setSimOutput] = useState<{ output: string, success: boolean, step: string } | null>(null);
    const [isRunning, setIsRunning] = useState(false);

    // Initialize params on load
    React.useEffect(() => {
        const initialInfo: Record<string, string> = {};
        data.params?.forEach(p => {
            const name = p.split('.').pop() || 'param';
            initialInfo[name] = ""; // Empty by default for user input

            // Auto-fill suggestion based on vuln type
            if (data.sinks && data.sinks.length > 0) {
                const type = data.sinks[0].type;
                if (type === 'RCE') initialInfo[name] = "cat /etc/passwd";
                if (type === 'SQLi') initialInfo[name] = "' OR 1=1 --";
                if (type === 'PathTraversal') initialInfo[name] = "../../../etc/passwd";
            }
        });
        setParamValues(initialInfo);
        setSimOutput(null);
    }, [data]);

    const handleRun = async () => {
        // REAL EXECUTION MODE
        // We now send the request to our Next.js Proxy, which forwards it to the running Python server (port 8000).

        setIsRunning(true);
        const targetUrl = `http://localhost:8000${data.path.replace(/:[a-zA-Z]+/g, '1')}`;

        // Prepare Payload
        const cookies: Record<string, string> = {};
        const payload: Record<string, string> = {};

        Object.keys(paramValues).forEach(key => {
            const isCookie = data.params?.some(p => p.endsWith(`.${key}`) && p.startsWith('cookie.'));
            if (isCookie) cookies[key] = paramValues[key];
            else payload[key] = paramValues[key];
        });

        try {
            const res = await fetch('/api/exploit/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    targetUrl,
                    method: data.method,
                    params: data.method === 'GET' ? payload : undefined,
                    data: data.method !== 'GET' ? payload : undefined,
                    cookies
                })
            });

            const result = await res.json();

            // Format result for "Simulation Output" display
            setSimOutput({
                output: result.error || result.data || '(Empty Response)',
                success: result.status >= 200 && result.status < 300,
                step: `Real Server Response (${result.status} ${result.statusText || ''})`
            });

            if (onRun) onRun(result);

        } catch (e: any) {
            setSimOutput({
                output: `Network Error: ${e.message}`,
                success: false,
                step: 'Connection Failed'
            });
        } finally {
            setIsRunning(false);
        }
    };

    const generatePythonScript = () => {
        // Target port 8000 as per server logs
        const targetUrl = `http://localhost:8000${data.path.replace(/:[a-zA-Z]+/g, '1')}`;
        const methodLower = data.method.toLowerCase();

        // Separate cookies from other params
        const cookies: Record<string, string> = {};
        const payload: Record<string, string> = {};

        Object.keys(paramValues).forEach(key => {
            // Check if key corresponds to a cookie param (heuristic via data.params or naming conv)
            const isCookie = data.params?.some(p => p.endsWith(`.${key}`) && p.startsWith('cookie.'));
            if (isCookie) {
                cookies[key] = paramValues[key];
            } else {
                payload[key] = paramValues[key];
            }
        });

        const hasCookies = Object.keys(cookies).length > 0;
        const hasPayload = Object.keys(payload).length > 0;

        let script = `import requests\nimport sys\n\ntarget_url = "${targetUrl}"\n`;

        if (hasCookies) script += `cookies = ${JSON.stringify(cookies, null, 4)}\n`;
        if (hasPayload) script += `payload = ${JSON.stringify(payload, null, 4)}\n`;

        script += `\nprint(f"[*] Attacking {target_url}...")\ntry:\n    r = requests.${methodLower}(target_url`;

        if (hasPayload) script += `, ${data.method === 'GET' ? 'params=payload' : 'data=payload'}`;
        if (hasCookies) script += `, cookies=cookies`;

        script += `, timeout=5)\n    print(f"[*] Status: {r.status_code}")\n    print("[*] Response body excerpt:")\n    print(r.text[:500])\nexcept Exception as e:\n    print(f"[!] Error: {e}")\n`;

        return script;
    };

    const exploitCode = generatePythonScript();

    const handleCopy = () => {
        navigator.clipboard.writeText(exploitCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    return (
        <div className="mt-6 bg-slate-950 rounded-lg border border-slate-800 overflow-hidden">
            <div className="flex items-center justify-between px-3 py-2 bg-slate-900 border-b border-slate-800">
                <div className="flex items-center gap-2 text-slate-300 text-xs font-semibold">
                    <Terminal size={14} className="text-green-500" />
                    <span>Exploit Builder</span>
                </div>
                {/* Actions */}
                <div className="flex items-center gap-2">
                    <button
                        onClick={handleRun}
                        className="bg-red-600 hover:bg-red-500 text-white text-[10px] px-2 py-1 rounded flex items-center gap-1 font-bold animate-pulse"
                    >
                        <Play size={10} fill="currentColor" /> TEST RUN
                    </button>
                    <button onClick={handleCopy} className="text-slate-400 hover:text-white">
                        {copied ? <span className="text-green-400 text-xs">Copied!</span> : <Copy size={14} />}
                    </button>
                </div>
            </div>

            {/* Parameter Inputs */}
            <div className="p-3 bg-slate-900 border-b border-slate-800 grid gap-3">
                {Object.keys(paramValues).map(key => (
                    <div key={key} className="flex flex-col gap-1">
                        <label className="text-[10px] text-blue-400 font-mono font-bold flex justify-between">
                            {key}
                            <span className="text-slate-500 font-normal">Input Payload</span>
                        </label>
                        <input
                            type="text"
                            className="bg-slate-950 border border-slate-700 rounded px-2 py-1.5 text-xs text-green-400 font-mono focus:border-red-500 focus:outline-none transition-colors"
                            value={paramValues[key]}
                            onChange={(e) => setParamValues({ ...paramValues, [key]: e.target.value })}
                            placeholder="Enter attack payload..."
                            onKeyDown={(e) => e.key === 'Enter' && handleRun()}
                        />
                    </div>
                ))}
                {Object.keys(paramValues).length === 0 && <span className="text-xs text-slate-500 italic">No parameters detected.</span>}
            </div>

            {/* CodeQL-Style Flow Trace */}
            <div className="border-b border-slate-800 bg-black/50 p-4 font-mono text-xs">
                <div className="flex items-center gap-2 text-slate-400 mb-4 select-none uppercase tracking-wider font-bold">
                    <Zap size={12} className="text-red-500" />
                    <span>Taint Propagation Trace</span>
                </div>

                <div className="space-y-4 relative">
                    {/* Vertical Line */}
                    <div className="absolute left-[11px] top-2 bottom-2 w-0.5 bg-slate-800 -z-10" />

                    {data.sinks?.[0]?.flowPath?.map((step: any, idx: number) => {
                        // Determine the value at this step based on user input
                        // This is a simplified simulation for visualization
                        let valuePreview = null;

                        // If it's a source or var, try to find matching input
                        if (step.type === 'source' || step.type === 'assign') {
                            // Try to match varName with input keys (heuristic)
                            const matchingKey = Object.keys(paramValues).find(k =>
                                step.label.toLowerCase().includes(k.toLowerCase()) ||
                                (step.varName && step.varName.toLowerCase().includes(k.toLowerCase()))
                            );

                            if (matchingKey) {
                                const val = paramValues[matchingKey];
                                if (val) valuePreview = val;
                            }
                        }

                        // If Sink, assume it received the tainted value
                        if (step.type === 'sink') {
                            const lastVal = Object.values(paramValues)[0]; // Just take first for demo
                            if (lastVal) valuePreview = lastVal;
                        }

                        // Determine Color
                        const isSink = step.type === 'sink';
                        const isSource = step.type === 'source';
                        const isActive = !!valuePreview;

                        return (
                            <div key={idx} className="flex items-start gap-3 group">
                                {/* Dot */}
                                <div className={`w-6 h-6 rounded-full flex items-center justify-center shrink-0 border 
                                    ${isSink ? 'bg-red-500/20 border-red-500 text-red-500' :
                                        isActive ? 'bg-blue-500/20 border-blue-500 text-blue-500' : 'bg-slate-800 border-slate-700 text-slate-500'} 
                                    transition-colors duration-300`}>
                                    <span className="text-[10px] font-bold">{idx + 1}</span>
                                </div>

                                {/* Content */}
                                <div className="flex-1 space-y-1">
                                    <div className="flex justify-between items-center">
                                        <span className={`font-bold ${isSink ? 'text-red-400' : 'text-slate-300'}`}>
                                            {isSource ? 'User Input (Source)' :
                                                isSink ? 'Vulnerability Trigger (Sink)' :
                                                    'Data Propagation'}
                                        </span>
                                        <span className="text-[10px] text-slate-600">Line {step.line}</span>
                                    </div>

                                    <div className="text-slate-400 bg-slate-900/50 p-2 rounded border border-slate-800">
                                        {step.label}
                                    </div>

                                    {/* Value Preview (The "Taint") */}
                                    {valuePreview && (
                                        <div className="flex items-center gap-2 text-[10px] animate-in slide-in-from-left-2 fade-in duration-300">
                                            <span className="text-slate-500">Current Value:</span>
                                            <code className="bg-red-950/30 text-red-300 px-1 py-0.5 rounded border border-red-900/30 break-all">
                                                "{valuePreview}"
                                            </code>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>

                {(!data.sinks?.[0]?.flowPath || data.sinks[0].flowPath.length === 0) && (
                    <div className="text-slate-500 italic text-center py-4">
                        No flow trace available for this node.
                    </div>
                )}
            </div>

            {/* Simulation Result Terminal */}
            {simOutput && (
                <div className="border-b border-slate-800 bg-black/50 p-3 font-mono text-xs">
                    <div className="flex items-center gap-2 text-slate-400 mb-2 select-none">
                        <Zap size={10} className="text-yellow-500" />
                        <span>Simulation Output</span>
                    </div>
                    <div className="space-y-1">
                        <div className="text-blue-400">$ {simOutput.step}</div>
                        <div className={`whitespace-pre-wrap pl-2 border-l-2 ${simOutput.success ? 'border-green-500 text-green-400' : 'border-red-500 text-red-400'}`}>
                            {simOutput.output}
                        </div>
                    </div>
                </div>
            )}

            <pre className="p-3 text-[10px] text-slate-500 font-mono overflow-x-auto max-h-[100px] opacity-60 hover:opacity-100 transition-opacity">
                {exploitCode}
            </pre>

            {/* Bypass Hints */}
            {data.sanitizers && data.sanitizers.length > 0 && (
                <div className="p-3 border-t border-slate-800 bg-yellow-950/10">
                    <div className="flex items-center gap-2 mb-2 text-yellow-500/80 text-xs font-bold">
                        <FlaskConical size={14} /> Bypass Hints
                    </div>
                    <ul className="text-[10px] text-yellow-100/60 list-disc list-inside space-y-1">
                        {data.sanitizers.map((s, i) => (
                            <li key={i}>{s.detail}</li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
    );
}
