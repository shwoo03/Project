# Vulnerability Detection Rules v2.0

rules:
  # [AUTH-001] Cookie-Based Authentication Bypass
  - id: auth-cookie-based-authorization
    languages: [python]
    severity: ERROR
    message: "[AUTH-001] 쿠키 값을 권한 검사에 사용 - 인증 우회 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.cookies.get($KEY, ...)
              - pattern: request.cookies[$KEY]
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: $VAR == "admin"
              - pattern: $VAR == 'admin'
              - pattern: '"admin" == $VAR'
              - pattern: "'admin' == $VAR"
              - pattern: render_template(..., ..., $VAR, ...)
    pattern-sanitizers:
      - patterns:
          - pattern-either:
              - pattern: session.get(...)
              - pattern: verify_token($VAR)
              - pattern: verify_token($VAR)
              - pattern: jwt.decode($VAR, ...)
              - pattern: $STORAGE.get($KEY)
              - pattern: $STORAGE[$KEY]
    metadata:
      cwe: ["CWE-565"]
      owasp: ["A01:2021"]
      level: beginner

  # [AUTH-002] Sensitive Data in Cookie
  - id: auth-sensitive-data-in-cookie
    languages: [python]
    severity: WARNING
    message: "[AUTH-002] 쿠키에 인증 정보 직접 저장 - 쿠키 조작 취약점 의심"
    patterns:
      - pattern-either:
          - pattern: $RESP.set_cookie("username", ...)
          - pattern: $RESP.set_cookie('username', ...)
          - pattern: $RESP.set_cookie("user", ...)
          - pattern: $RESP.set_cookie('user', ...)
          - pattern: $RESP.set_cookie("user_id", ...)
          - pattern: $RESP.set_cookie('user_id', ...)
          - pattern: $RESP.set_cookie("role", ...)
          - pattern: $RESP.set_cookie('role', ...)
          - pattern: $RESP.set_cookie("admin", ...)
          - pattern: $RESP.set_cookie('admin', ...)
          - pattern: $RESP.set_cookie("is_admin", ...)
          - pattern: $RESP.set_cookie('is_admin', ...)
    metadata:
      cwe: ["CWE-565"]
      owasp: ["A01:2021"]
      level: beginner

  # [SQLI-001] SQL Injection
  - id: sqli-taint-flask
    languages: [python]
    severity: ERROR
    message: "[SQLI-001] 사용자 입력이 SQL 쿼리에 삽입됨 - SQL 인젝션 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.args.get(...)
              - pattern: request.form.get(...)
              - pattern: request.args[...]
              - pattern: request.form[...]
              - pattern: request.values.get(...)
              - pattern: request.json.get(...)
              - pattern: request.data
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: $CURSOR.execute($QUERY)
              - pattern: $CURSOR.executemany($QUERY, ...)
              - pattern: $DB.execute($QUERY)
              - pattern: $DB.raw($QUERY)
              - pattern: get_db().execute($QUERY)
              - pattern: query_db($QUERY)
              - pattern: text($QUERY)
    pattern-sanitizers:
      - patterns:
          - pattern-either:
              - pattern: $CURSOR.execute($QUERY, $PARAMS)
              - pattern: $CURSOR.execute($QUERY, ($PARAMS,))
              - pattern: int($VAR)
              - pattern: str(int($VAR))
    metadata:
      cwe: ["CWE-89"]
      owasp: ["A03:2021"]
      level: LEVEL1

  # [CMDI-001] Command Injection
  - id: cmdi-taint-flask
    languages: [python]
    severity: ERROR
    message: "[CMDI-001] 사용자 입력이 시스템 명령어에 삽입됨 - 명령어 인젝션 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.args.get(...)
              - pattern: request.form.get(...)
              - pattern: request.args[...]
              - pattern: request.form[...]
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: os.system($CMD)
              - pattern: os.popen($CMD)
              - pattern: subprocess.call($CMD, shell=True, ...)
              - pattern: subprocess.run($CMD, shell=True, ...)
              - pattern: subprocess.Popen($CMD, shell=True, ...)
              - pattern: subprocess.check_output($CMD, ...)
              - pattern: subprocess.check_output([..., $CMD, ...], ...)
              - pattern: eval($CMD)
              - pattern: exec($CMD)
    pattern-sanitizers:
      - patterns:
          - pattern-either:
              - pattern: shlex.quote($VAR)
              - pattern: shlex.split($VAR)
    metadata:
      cwe: ["CWE-78"]
      owasp: ["A03:2021"]
      level: LEVEL1

  # [PATH-001] Path Traversal
  - id: path-traversal-taint-flask
    languages: [python]
    severity: ERROR
    message: "[PATH-001] 사용자 입력이 파일 경로에 사용됨 - 경로 탐색 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.args.get(...)
              - pattern: request.form.get(...)
              - pattern: request.args[...]
              - pattern: request.form[...]
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: open($PATH, ...)
              - pattern: send_file($PATH, ...)
              - pattern: send_from_directory(..., $PATH, ...)
    pattern-sanitizers:
      - patterns:
          - pattern-either:
              - pattern: secure_filename($VAR)
              - pattern: os.path.basename($VAR)
    metadata:
      cwe: ["CWE-22"]
      owasp: ["A01:2021"]
      level: LEVEL1

  # [SSTI-001] Server-Side Template Injection
  - id: ssti-taint-flask
    languages: [python]
    severity: ERROR
    message: "[SSTI-001] 사용자 입력이 템플릿에 삽입됨 - 템플릿 인젝션 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.args.get(...)
              - pattern: request.form.get(...)
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: render_template_string($TEMPLATE)
              - pattern: Template($TEMPLATE).render(...)
              - pattern: Environment(...).from_string($TEMPLATE)
    pattern-sanitizers:
      - patterns:
          - pattern: escape($VAR)
    metadata:
      cwe: ["CWE-94"]
      owasp: ["A03:2021"]
      level: LEVEL1

  # [XSS-001] Reflected XSS
  - id: xss-reflected-flask
    languages: [python]
    severity: WARNING
    message: "[XSS-001] 사용자 입력이 HTML 응답에 포함됨 - XSS 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.args.get(...)
              - pattern: request.form.get(...)
              - pattern: request.args[...]
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: make_response($RESP)
              - pattern: return $RESP
    pattern-sanitizers:
      - patterns:
          - pattern-either:
              - pattern: escape($VAR)
              - pattern: html.escape($VAR)
              - pattern: markupsafe.escape($VAR)
              - pattern: render_template(...)
              - pattern: redirect(...)
              - pattern: render_template(...)
              - pattern: redirect(...)
              - pattern: jsonify(...)
              - pattern: query_db(...)
    metadata:
      cwe: ["CWE-79"]
      owasp: ["A03:2021"]
      level: LEVEL1

  # [DESERIAL-001] Insecure Deserialization
  - id: deserial-pickle-taint
    languages: [python]
    severity: ERROR
    message: "[DESERIAL-001] 사용자 입력이 역직렬화에 사용됨 - 안전하지 않은 역직렬화 취약점 의심"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: request.args.get(...)
              - pattern: request.form.get(...)
              - pattern: request.data
              - pattern: request.get_json()
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: pickle.loads($DATA)
              - pattern: pickle.load($FILE)
              - pattern: cPickle.loads($DATA)
              - pattern: yaml.load($DATA)
              - pattern: yaml.unsafe_load($DATA)
    metadata:
      cwe: ["CWE-502"]
      owasp: ["A08:2021"]
      level: LEVEL2

  # [HARDCODED-001] Hardcoded Secret Key
  - id: hardcoded-secret-key
    languages: [python]
    severity: WARNING
    message: "[HARDCODED-001] 하드코딩된 시크릿 키 발견 - 자격 증명 노출 취약점 의심"
    pattern-either:
      - pattern: app.secret_key = "..."
      - pattern: app.secret_key = '...'
      - pattern: SECRET_KEY = "..."
      - pattern: SECRET_KEY = '...'
    metadata:
      cwe: ["CWE-798"]
      owasp: ["A07:2021"]
      level: beginner

  # [DEBUG-001] Debug Mode Enabled
  - id: flask-debug-enabled
    languages: [python]
    severity: WARNING
    message: "[DEBUG-001] Flask 디버그 모드 활성화 - 정보 노출 취약점 의심"
    patterns:
      - pattern-either:
          - pattern: app.run(..., debug=True, ...)
          - pattern: app.debug = True
    metadata:
      cwe: ["CWE-489"]
      owasp: ["A05:2021"]
      level: beginner

  # [INFO-001] Sensitive Data in HTML Comment
  - id: sensitive-data-in-html-comment
    languages: [html]
    severity: WARNING
    message: "[INFO-001] HTML 주석에 민감한 정보 포함 - 정보 노출 취약점 의심"
    pattern-either:
      - pattern-regex: '<!--.*?(password|passwd|pwd|secret|key|token|flag|api_key|apikey|auth|credential|private).*?-->'
      - pattern-regex: '<!--.*?(DH\{|FLAG\{|CTF\{|flag\{|HTB\{).*?-->'
    metadata:
      cwe: ["CWE-615"]
      owasp: ["A01:2021"]
      level: beginner

  # [AUTH-003] Commented Out Auth Logic
  - id: commented-out-auth-logic
    languages: [python]
    severity: WARNING
    message: "[AUTH-003] 주석 처리된 인증 로직 발견 - 접근 제어 취약점 의심"
    patterns:
      - pattern-regex: '#\s*if\s+\w+\s*(!=|==)\s*[\''"]admin[\''"]'
    metadata:
      cwe: ["CWE-284"]
      owasp: ["A01:2021"]
      level: LEVEL 1

  # [RANDOM-001] Weak Randomness / Insufficient Entropy
  - id: random-weak-entropy
    languages: [python]
    severity: WARNING
    message: "[RANDOM-001] 취약한 난수 사용 또는 낮은 엔트로피 - 세션 예측 취약점 의심"
    patterns:
      - pattern-either:
          - pattern: os.urandom(1)
          - pattern: os.urandom(2)
          - pattern: os.urandom(3)
          - pattern: random.randint(...)
          - pattern: random.random(...)
    metadata:
      cwe: ["CWE-330"]
      owasp: ["A02:2021"]
      level: beginner

  # [PHP-001] Loose Comparison / Type Juggling
  - id: php-loose-comparison
    languages: [php]
    severity: WARNING
    message: "[PHP-001] 느슨한 비교 연산자 사용 - 타입 저글링 취약점 의심 (가능하면 ===, !== 사용 권장)"
    patterns:
      - pattern-either:
          - pattern: $X == $Y
          - pattern: $X != $Y
          - pattern: $X < $Y
          - pattern: $X > $Y
          - pattern: $X <= $Y
          - pattern: $X >= $Y
    metadata:
      cwe: ["CWE-480"]
      owasp: ["A01:2021"]
      level: beginner

