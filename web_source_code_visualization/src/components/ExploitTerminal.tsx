import React, { useState, useRef, useEffect } from 'react';
import { ShieldAlert, Terminal, X, Maximize2, Minimize2 } from 'lucide-react';

export default function ExploitTerminal() {
    // Dynamic import for simulator to avoid SSR issues if any, though simulator is pure JS.
    // Keeping it simple.
    const [simResult, setSimResult] = useState<{ output: string, success: boolean, step: string } | null>(null);
    const [isExpanded, setIsExpanded] = useState(false);
    const [history, setHistory] = useState<{ cmd: string, res: any }[]>([]);
    const bottomRef = useRef<HTMLDivElement>(null);

    const runSimulation = async (payload: string) => {
        try {
            const mod = await import('@/lib/simulator');
            // Simple heuristic to guess vuln type if not specified
            const vulnType = payload.includes('cat') || payload.includes('ls') ? 'RCE' : 'SQLi';
            const res = mod.simulateExploit(vulnType, payload);

            setSimResult(res);
            setHistory(prev => [...prev, { cmd: payload, res }]);
        } catch (e) {
            console.error(e);
        }
    };

    useEffect(() => {
        if (bottomRef.current) bottomRef.current.scrollIntoView({ behavior: 'smooth' });
    }, [history]);

    return (
        <div className={`fixed bottom-0 left-0 right-0 bg-slate-950 border-t border-slate-800 transition-all duration-300 z-40 flex flex-col ${isExpanded ? 'h-96' : 'h-12'}`}>
            {/* Header / Toggle Bar */}
            <div
                className="flex items-center px-4 h-12 bg-slate-900 cursor-pointer hover:bg-slate-800 transition-colors border-b border-slate-800"
                onClick={() => setIsExpanded(!isExpanded)}
            >
                <div className="flex items-center gap-2 text-slate-300 font-mono text-sm select-none flex-1">
                    <Terminal size={14} className="text-pink-500" />
                    <span className="font-bold">Exploit Terminal</span>
                    <span className="text-slate-600 text-xs ml-2">Verified Interactive Shell</span>
                </div>
                <div className="flex items-center gap-2 text-slate-500">
                    {isExpanded ? <Minimize2 size={14} /> : <Maximize2 size={14} />}
                </div>
            </div>

            {/* Terminal Handler */}
            {isExpanded && (
                <div className="flex-1 flex flex-col p-4 overflow-hidden bg-black/50 backdrop-blur-sm">
                    {/* History Output */}
                    <div className="flex-1 overflow-y-auto space-y-4 mb-4 custom-scrollbar font-mono text-xs p-2">
                        <div className="text-slate-500 italic">Connected to Virtual Environment... (Try 'cat /flag', 'ls', 'whoami')</div>

                        {history.map((entry, idx) => (
                            <div key={idx} className="space-y-1">
                                <div className="flex items-center gap-2 text-slate-300">
                                    <span className="text-pink-500 font-bold">$</span>
                                    <span>{entry.cmd}</span>
                                </div>
                                <div className="pl-4 border-l-2 border-slate-800 text-slate-400 whitespace-pre-wrap">
                                    {entry.res.output}
                                </div>
                            </div>
                        ))}
                        <div ref={bottomRef} />
                    </div>

                    {/* Input Area */}
                    <div className="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 focus-within:ring-1 focus-within:ring-pink-500/50 focus-within:border-pink-500/50 transition-all shadow-lg">
                        <span className="text-pink-500 font-bold font-mono animate-pulse">{'>'}</span>
                        <input
                            type="text"
                            className="bg-transparent border-none outline-none text-white w-full font-mono text-sm placeholder:text-slate-600"
                            placeholder="Type command..."
                            autoFocus
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                    runSimulation(e.currentTarget.value);
                                    e.currentTarget.value = '';
                                }
                            }}
                        />
                    </div>
                </div>
            )}
        </div>
    );
}
