"use client";

import React, { useCallback, useRef, useEffect, useMemo, useState } from 'react';
import { useVirtualizer } from '@tanstack/react-virtual';
import { SecurityFinding } from '@/types/graph';
import { useInfiniteVulnerabilities } from '@/hooks/useAnalysisQuery';

interface InfiniteVulnerabilityListProps {
    /** í”„ë¡œì íŠ¸ ê²½ë¡œ */
    projectPath: string;
    /** í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ */
    pageSize?: number;
    /** ì‹¬ê°ë„ í•„í„° */
    severity?: string;
    /** í•­ëª© í´ë¦­ í•¸ë“¤ëŸ¬ */
    onItemClick?: (finding: SecurityFinding) => void;
    /** ì„ íƒëœ í•­ëª© ID */
    selectedId?: string;
    /** ë†’ì´ (ê¸°ë³¸ê°’: 400px) */
    height?: number | string;
}

const SEVERITY_COLORS: Record<string, string> = {
    critical: 'bg-red-600 text-white',
    high: 'bg-orange-500 text-white',
    medium: 'bg-yellow-500 text-black',
    low: 'bg-blue-500 text-white',
    info: 'bg-gray-500 text-white',
};

const SEVERITY_ICONS: Record<string, string> = {
    critical: 'ğŸ”´',
    high: 'ğŸŸ ',
    medium: 'ğŸŸ¡',
    low: 'ğŸ”µ',
    info: 'â„¹ï¸',
};

/**
 * ë¬´í•œ ìŠ¤í¬ë¡¤ ì·¨ì•½ì  ëª©ë¡ ì»´í¬ë„ŒíŠ¸
 * 
 * @tanstack/react-virtualì„ ì‚¬ìš©í•˜ì—¬ ëŒ€ëŸ‰ì˜ ì·¨ì•½ì ì„
 * íš¨ìœ¨ì ìœ¼ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. ìŠ¤í¬ë¡¤ ì‹œ ìë™ìœ¼ë¡œ ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
 */
export function InfiniteVulnerabilityList({
    projectPath,
    pageSize = 20,
    severity,
    onItemClick,
    selectedId,
    height = 400,
}: InfiniteVulnerabilityListProps) {
    const parentRef = useRef<HTMLDivElement>(null);

    // React Query ë¬´í•œ ìŠ¤í¬ë¡¤ ì¿¼ë¦¬
    const {
        data,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage,
        isLoading,
        isError,
        error,
    } = useInfiniteVulnerabilities(projectPath, pageSize, severity);

    // ëª¨ë“  í˜ì´ì§€ì˜ í•­ëª©ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í‰íƒ„í™”
    const allItems = useMemo(() => {
        if (!data?.pages) return [];
        return data.pages.flatMap((page) => page.items);
    }, [data?.pages]);

    // ê°€ìƒí™” ì„¤ì •
    const virtualizer = useVirtualizer({
        count: hasNextPage ? allItems.length + 1 : allItems.length, // ë¡œë”© ì¸ë””ì¼€ì´í„°ìš© +1
        getScrollElement: () => parentRef.current,
        estimateSize: () => 80, // ê° í•­ëª©ì˜ ì˜ˆìƒ ë†’ì´
        overscan: 5, // ë·°í¬íŠ¸ ë°”ê¹¥ì— ë¯¸ë¦¬ ë Œë”ë§í•  í•­ëª© ìˆ˜
    });

    const virtualItems = virtualizer.getVirtualItems();

    // ë§ˆì§€ë§‰ í•­ëª©ì— ë„ë‹¬í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
    useEffect(() => {
        const lastItem = virtualItems[virtualItems.length - 1];
        
        if (!lastItem) return;

        // ë§ˆì§€ë§‰ í•­ëª©ì´ ë³´ì´ê³ , ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆê³ , í˜„ì¬ ë¡œë”© ì¤‘ì´ ì•„ë‹ˆë©´
        if (
            lastItem.index >= allItems.length - 1 &&
            hasNextPage &&
            !isFetchingNextPage
        ) {
            fetchNextPage();
        }
    }, [virtualItems, allItems.length, hasNextPage, isFetchingNextPage, fetchNextPage]);

    // ë¡œë”© ìƒíƒœ
    if (isLoading) {
        return (
            <div 
                className="flex items-center justify-center text-gray-400"
                style={{ height }}
            >
                <div className="flex items-center gap-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-blue-500" />
                    <span>ì·¨ì•½ì  ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        );
    }

    // ì—ëŸ¬ ìƒíƒœ
    if (isError) {
        return (
            <div 
                className="flex items-center justify-center text-red-400"
                style={{ height }}
            >
                <span>ì˜¤ë¥˜: {(error as Error)?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</span>
            </div>
        );
    }

    // ë¹ˆ ìƒíƒœ
    if (allItems.length === 0) {
        return (
            <div 
                className="flex flex-col items-center justify-center text-gray-400"
                style={{ height }}
            >
                <span className="text-4xl mb-2">âœ…</span>
                <span>ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤</span>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full">
            {/* í—¤ë” */}
            <div className="flex items-center justify-between px-3 py-2 bg-gray-800 border-b border-gray-700">
                <span className="text-sm font-medium text-gray-300">
                    ì·¨ì•½ì  ({data?.pages[0]?.total ?? allItems.length}ê°œ)
                </span>
                {severity && (
                    <span className={`text-xs px-2 py-1 rounded ${SEVERITY_COLORS[severity] || 'bg-gray-600'}`}>
                        {severity.toUpperCase()}
                    </span>
                )}
            </div>

            {/* ê°€ìƒí™”ëœ ëª©ë¡ */}
            <div
                ref={parentRef}
                className="flex-1 overflow-auto"
                style={{ height }}
            >
                <div
                    style={{
                        height: `${virtualizer.getTotalSize()}px`,
                        width: '100%',
                        position: 'relative',
                    }}
                >
                    {virtualItems.map((virtualRow) => {
                        const isLoaderRow = virtualRow.index > allItems.length - 1;
                        const item = allItems[virtualRow.index];

                        return (
                            <div
                                key={virtualRow.key}
                                data-index={virtualRow.index}
                                ref={virtualizer.measureElement}
                                style={{
                                    position: 'absolute',
                                    top: 0,
                                    left: 0,
                                    width: '100%',
                                    transform: `translateY(${virtualRow.start}px)`,
                                }}
                            >
                                {isLoaderRow ? (
                                    <div className="flex items-center justify-center py-4 text-gray-400">
                                        <div className="animate-spin rounded-full h-4 w-4 border-t-2 border-blue-500 mr-2" />
                                        ë” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                    </div>
                                ) : (
                                    <VulnerabilityItem
                                        finding={item}
                                        isSelected={selectedId === item.id}
                                        onClick={() => onItemClick?.(item)}
                                    />
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* í‘¸í„° */}
            {isFetchingNextPage && (
                <div className="px-3 py-2 bg-gray-800 border-t border-gray-700 text-center text-sm text-gray-400">
                    ë‹¤ìŒ í˜ì´ì§€ ë¡œë”© ì¤‘...
                </div>
            )}
        </div>
    );
}

// ê°œë³„ ì·¨ì•½ì  í•­ëª© ì»´í¬ë„ŒíŠ¸
interface VulnerabilityItemProps {
    finding: SecurityFinding;
    isSelected?: boolean;
    onClick?: () => void;
}

const VulnerabilityItem = React.memo(function VulnerabilityItem({
    finding,
    isSelected,
    onClick,
}: VulnerabilityItemProps) {
    const severityClass = SEVERITY_COLORS[finding.severity?.toLowerCase() || 'info'] || SEVERITY_COLORS.info;
    const severityIcon = SEVERITY_ICONS[finding.severity?.toLowerCase() || 'info'] || SEVERITY_ICONS.info;

    return (
        <div
            className={`
                px-3 py-2 border-b border-gray-700 cursor-pointer
                transition-colors duration-150
                ${isSelected ? 'bg-blue-900/50' : 'hover:bg-gray-800/50'}
            `}
            onClick={onClick}
        >
            <div className="flex items-start gap-2">
                {/* ì‹¬ê°ë„ ì•„ì´ì½˜ */}
                <span className="text-lg mt-0.5">{severityIcon}</span>

                <div className="flex-1 min-w-0">
                    {/* ì œëª© */}
                    <div className="flex items-center gap-2">
                        <span className={`text-xs px-1.5 py-0.5 rounded ${severityClass}`}>
                            {finding.severity?.toUpperCase() || 'INFO'}
                        </span>
                        <span className="text-sm font-medium text-gray-200 truncate">
                            {finding.check_id || finding.rule_id || 'Unknown'}
                        </span>
                    </div>

                    {/* ë©”ì‹œì§€ */}
                    <p className="text-xs text-gray-400 mt-1 line-clamp-2">
                        {finding.message || finding.extra?.message || 'ì„¤ëª… ì—†ìŒ'}
                    </p>

                    {/* íŒŒì¼ ìœ„ì¹˜ */}
                    <div className="flex items-center gap-2 mt-1 text-xs text-gray-500">
                        <span className="truncate max-w-[200px]" title={finding.path}>
                            ğŸ“ {finding.path?.split('/').pop() || 'unknown'}
                        </span>
                        {finding.start?.line && (
                            <span>:{finding.start.line}</span>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
});

export default InfiniteVulnerabilityList;
